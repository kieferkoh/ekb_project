<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Crypto Lab — Weak Key Demo</title>
    <!-- Bootstrap for quick styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            padding-top: 2.5rem;
        }
        
        .warning {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
            padding: .75rem 1rem;
        }
        
        pre.pem {
            max-height: 180px;
            overflow: auto;
            background: #f8f9fa;
            padding: .5rem;
        }
        
        .small-muted {
            font-size: .9rem;
            color: #6c757d;
        }
    </style>
</head>

<body>
    <div class="container">

        <header class="mb-4">
            <h1 class="h3">Crypto Lab — Weak RSA / ECC Demo</h1>
        </header>

        <div class="row">
            <div class="col-md-8">

                <!-- Flash messages -->
                {% with messages = get_flashed_messages() %} {% if messages %}
                <div class="mb-3">
                    {% for m in messages %}
                    <div class="alert alert-info" role="alert">{{ m }}</div>
                    {% endfor %}
                </div>
                {% endif %} {% endwith %}

                <!-- RSA form -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>1) RSA - Upload PEM public key (lab only)</strong>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{{ url_for('upload_rsa') }}">
                            <div class="mb-2">
                                <label for="pem_rsa" class="form-label">Paste RSA public key (PEM)</label>
                                <textarea id="pem_rsa" name="pem" class="form-control" rows="6" placeholder="-----BEGIN PUBLIC KEY----- ..."></textarea>
                            </div>
                            <button class="btn btn-primary" type="submit">Check & attempt Fermat (toy only)</button>
                            <div class="mt-2 small-muted">Refuses keys &gt; 64 bits. For demonstration, use the built-in toy generator (see README).</div>
                        </form>
                    </div>
                </div>

                <!-- ECC PEM form -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>2) ECC - Upload PEM public key (lab only)</strong>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{{ url_for('upload_ecc') }}">
                            <div class="mb-2">
                                <label for="pem_ecc" class="form-label">Paste EC public key (PEM)</label>
                                <textarea id="pem_ecc" name="pem" class="form-control" rows="6" placeholder="-----BEGIN PUBLIC KEY----- ..."></textarea>
                            </div>
                            <button class="btn btn-primary" type="submit">Parse (toy only)</button>
                            <div class="mt-2 small-muted">This parses the PEM and will refuse to proceed if the curve/key_size &gt; 64 bits. Automatic attacks require explicit toy params below.</div>
                        </form>
                    </div>
                </div>

                <!-- Toy ECC generator + attack -->
                <div class="card mb-3">
                    <div class="card-header">
                        <strong>3) Toy ECC demo (canned example)</strong>
                    </div>
                    <div class="card-body">
                        <p class="small-muted">Use the canned toy ECC parameters (server-generated) and run the brute-force demo that finds <code>d mod r</code>. These are intentionally tiny values.</p>

                        <div class="mb-2">
                            <button id="btn_gen_toy" class="btn btn-outline-secondary">Generate Toy ECC (AJAX)</button>
                            <span id="gen_note" class="ms-2 small text-muted"></span>
                        </div>

                        <form id="attackToyForm" method="post" action="{{ url_for('attack_toy_ecc') }}">
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <label class="form-label">p</label>
                                    <input id="p" name="p" class="form-control form-control-sm" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">a</label>
                                    <input id="a" name="a" class="form-control form-control-sm" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">b</label>
                                    <input id="b" name="b" class="form-control form-control-sm" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">r (order)</label>
                                    <input id="r" name="r" class="form-control form-control-sm" />
                                </div>
                            </div>

                            <div class="row g-2 mt-2">
                                <div class="col-md-3">
                                    <label class="form-label">Gx</label>
                                    <input id="Gx" name="Gx" class="form-control form-control-sm" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Gy</label>
                                    <input id="Gy" name="Gy" class="form-control form-control-sm" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Qx</label>
                                    <input id="Qx" name="Qx" class="form-control form-control-sm" />
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Qy</label>
                                    <input id="Qy" name="Qy" class="form-control form-control-sm" />
                                </div>
                            </div>


                            <div class="mt-3">
                                <button id="btn_attack_toy" class="btn btn-danger" type="submit">Run toy ECC attack (brute-force d mod r)</button>
                                <button id="btn_clear" type="button" class="btn btn-outline-secondary ms-2">Clear</button>
                            </div>
                            <div class="mt-2 small-muted">Safety limits: server will refuse field sizes &gt; 64 bits, and will refuse r &gt; 10000.</div>
                        </form>
                    </div>
                </div>

            </div>

            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header"><strong>Quick guide</strong></div>
                    <div class="card-body small">
                        <ol>
                            <li>Use <strong>Generate Toy ECC</strong> to get a canned sample (recommended for demo).</li>
                            <li>Click <strong>Run toy ECC attack</strong> to brute force <code>d mod r</code> for the toy curve.</li>
                            <li>For RSA, paste a tiny RSA <code>N</code> PEM (≤64 bits) and run the Fermat demo.</li>
                        </ol>
                        <p class="mb-0"><strong>Tip:</strong> Keep the app on localhost and do not expose it publicly.</p>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <script>
        // Helper: fetch toy ECC params and populate the form
        document.getElementById('btn_gen_toy').addEventListener('click', async function() {
            const btn = this;
            btn.disabled = true;
            document.getElementById('gen_note').textContent = 'Generating...';
            try {
                const resp = await fetch('{{ url_for("generate_toy_ecc") }}');
                if (!resp.ok) throw new Error('Server error: ' + resp.status);
                const js = await resp.json();
                if (js.status !== 'ok') throw new Error(js.msg || 'failed');
                const t = js.toy;
                // populate fields
                ['p', 'a', 'b', 'Gx', 'Gy', 'r', 'Qx', 'Qy'].forEach(k => {
                    const el = document.getElementById(k);
                    if (el) el.value = t[k];
                });
                document.getElementById('gen_note').textContent = 'Toy ECC params loaded into the form below.';
            } catch (err) {
                console.error(err);
                document.getElementById('gen_note').textContent = 'Error: ' + err.message;
                alert('Could not generate toy ECC: ' + err.message);
            } finally {
                btn.disabled = false;
                setTimeout(() => document.getElementById('gen_note').textContent = '', 6000);
            }
        });

        // Clear button
        document.getElementById('btn_clear').addEventListener('click', function() {
            ['p', 'a', 'b', 'Gx', 'Gy', 'r', 'Qx', 'Qy'].forEach(k => {
                const el = document.getElementById(k);
                if (el) el.value = '';
            });
            document.getElementById('accept_toy').checked = false;
        });

        // Optional: block submission if toy accept not checked
        document.getElementById('attackToyForm').addEventListener('submit', function(evt) {
            const ok = document.getElementById('accept_toy').checked;
            if (!ok) {
                evt.preventDefault();
                alert('Please confirm you own this toy key and are running locally (check the box).');
            }
        });
    </script>

</body>

</html>